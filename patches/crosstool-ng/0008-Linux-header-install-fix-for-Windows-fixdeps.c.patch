From 8159e62e1d1648ed672151845261babb25b0e7f3 Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Tue, 3 Dec 2013 00:16:22 +0000
Subject: [PATCH 8/8] Linux header install fix for Windows (fixdeps.c)

---
 .../3.10.19/100-fixdep-fixes-for-Windows.patch     | 77 ++++++++++++++++++++++
 1 file changed, 77 insertions(+)
 create mode 100644 patches/linux/3.10.19/100-fixdep-fixes-for-Windows.patch

diff --git a/patches/linux/3.10.19/100-fixdep-fixes-for-Windows.patch b/patches/linux/3.10.19/100-fixdep-fixes-for-Windows.patch
new file mode 100644
index 0000000..726b85e
--- /dev/null
+++ b/patches/linux/3.10.19/100-fixdep-fixes-for-Windows.patch
@@ -0,0 +1,77 @@
+--- a/scripts/basic/fixdep.c	2013-11-13 03:05:59.000000000 +0000
++++ b/scripts/basic/fixdep.c	2013-12-02 22:49:14.266122500 +0000
+@@ -105,7 +105,9 @@
+ 
+ #include <sys/types.h>
+ #include <sys/stat.h>
++#ifndef __MINGW32__
+ #include <sys/mman.h>
++#endif
+ #include <unistd.h>
+ #include <fcntl.h>
+ #include <string.h>
+@@ -113,13 +115,64 @@
+ #include <stdio.h>
+ #include <limits.h>
+ #include <ctype.h>
++#ifndef __MINGW32__
+ #include <arpa/inet.h>
++#else
++#include <alloca.h>
++#endif
+ 
+ #define INT_CONF ntohl(0x434f4e46)
+ #define INT_ONFI ntohl(0x4f4e4649)
+ #define INT_NFIG ntohl(0x4e464947)
+ #define INT_FIG_ ntohl(0x4649475f)
+ 
++#ifdef __MINGW32__
++#define UNUSED __attribute__ ((__unused__))
++
++/* Workaround specifically for fixdep */
++#define PROT_READ 0
++#define MAP_PRIVATE 0
++void *mmap(void *start UNUSED, size_t size, int prot UNUSED,
++	   int flags UNUSED, int fd, off_t offset UNUSED)
++{
++	void *p;
++	void *curP;
++	ssize_t readB;
++
++	p = malloc(size);
++	if (!p)
++		return (void*)((long)-1);
++
++	curP = p;
++
++	while (size > 0)
++	{
++		readB = read(fd, curP, size);
++
++		if (readB == 0)
++		{
++			/* EOF reached */
++			break;
++		}
++		else if (readB < 0)
++		{
++			perror("fixdep: read config");
++			free(p);
++			return (void*)((long)-1);
++		}
++
++		size -= readB;
++		curP += readB;
++	}
++
++	return p;
++}
++void munmap(void *p, size_t size UNUSED)
++{
++	free(p);
++}
++#endif
++
+ char *target;
+ char *depfile;
+ char *cmdline;
-- 
1.8.4.2

