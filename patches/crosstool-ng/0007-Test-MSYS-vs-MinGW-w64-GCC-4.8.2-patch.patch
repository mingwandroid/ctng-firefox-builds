From f05dd67aa73048b05a4cf007ec42df0127919539 Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Sun, 1 Dec 2013 16:57:31 +0000
Subject: [PATCH 7/7] Test MSYS vs MinGW-w64 GCC 4.8.2 patch

---
 .../gcc/4.8.2/100-msys-native-paths-gengtype.patch | 103 +++++++++++++++++++++
 1 file changed, 103 insertions(+)
 create mode 100644 patches/gcc/4.8.2/100-msys-native-paths-gengtype.patch

diff --git a/patches/gcc/4.8.2/100-msys-native-paths-gengtype.patch b/patches/gcc/4.8.2/100-msys-native-paths-gengtype.patch
new file mode 100644
index 0000000..1049871
--- /dev/null
+++ b/patches/gcc/4.8.2/100-msys-native-paths-gengtype.patch
@@ -0,0 +1,103 @@
+diff -urN gcc-4.8.2.orig/gcc/configure gcc-4.8.2/gcc/configure
+--- gcc-4.8.2.orig/gcc/configure	2013-12-01 21:38:48.051307500 +0000
++++ gcc-4.8.2/gcc/configure	2013-12-01 21:44:52.965145700 +0000
+@@ -934,6 +934,7 @@
+ CCC
+ CPP
+ CXXCPP
++abs_srcdir_native
+ GMPLIBS
+ GMPINC
+ ISLLIBS
+@@ -3267,6 +3268,15 @@
+ *** and run configure again." "$LINENO" 5
+ fi
+ 
++# Hack for MSYS2 gengtypes filename emission when build
++# machine is mingw*.
++case $build_os in
++  mingw*)
++    abs_srcdir_native=$(cd $srcdir; pwd -W) ;;
++  *)
++    abs_srcdir_native=$(cd $srcdir; pwd) ;;
++esac
++
+ # -----------
+ # Directories
+ # -----------
+@@ -28655,6 +28665,7 @@
+ s&@top_build_prefix@&$ac_top_build_prefix&;t t
+ s&@srcdir@&$ac_srcdir&;t t
+ s&@abs_srcdir@&$ac_abs_srcdir&;t t
++s&@abs_srcdir_native@&$abs_srcdir_native&;t t
+ s&@top_srcdir@&$ac_top_srcdir&;t t
+ s&@abs_top_srcdir@&$ac_abs_top_srcdir&;t t
+ s&@builddir@&$ac_builddir&;t t
+diff -urN gcc-4.8.2.orig/gcc/configure.ac gcc-4.8.2/gcc/configure.ac
+--- gcc-4.8.2.orig/gcc/configure.ac	2013-12-01 21:38:48.051807600 +0000
++++ gcc-4.8.2/gcc/configure.ac	2013-12-01 21:44:51.323437200 +0000
+@@ -97,6 +97,15 @@
+ *** and run configure again.])
+ fi
+ 
++# Hack for MSYS2 gengtypes filename emission when build
++# machine is mingw*.
++case $build_os in
++  mingw*)
++    abs_srcdir_native=$(cd $srcdir; pwd -W) ;;
++  *)
++    abs_srcdir_native=$(cd $srcdir; pwd) ;;
++esac
++
+ # -----------
+ # Directories
+ # -----------
+@@ -5305,6 +5314,14 @@
+ 
+ # Create the Makefile
+ # and configure language subdirectories
++
++if test "$build_os" != "mingw32" ; then
++    abs_srcdir_native=$ac_abs_srcdir
++else
++    abs_srcdir_native=$(cd $ac_abs_srcdir; pwd -W)
++fi
++AC_SUBST(abs_srcdir_native)
++
+ AC_CONFIG_FILES($all_outputs)
+ 
+ AC_CONFIG_COMMANDS([default],
+diff -urN gcc-4.8.2.orig/gcc/Makefile.in gcc-4.8.2/gcc/Makefile.in
+--- gcc-4.8.2.orig/gcc/Makefile.in	2013-12-01 21:38:48.342844500 +0000
++++ gcc-4.8.2/gcc/Makefile.in	2013-12-01 21:40:08.123975500 +0000
+@@ -72,6 +72,9 @@
+ 
+ # Directory where sources are, absolute.
+ abs_srcdir = @abs_srcdir@
++# Directory where sources are, absolute, natively (for MSYS/Cygwin)
++abs_srcdir_native = @abs_srcdir_native@
++
+ abs_docdir = @abs_srcdir@/doc
+ 
+ # Top build directory for this package, relative to here.
+@@ -297,6 +300,11 @@
+ 			  $(shell expr $(range) + $(write_entries_to_file_split) - 1), $(1))" \
+ 	     | tr ' ' '\012' >> $(2)))
+ 
++# write_entries_to_file_native - as above, but replaces each entry with it's native
++# version first.
++# Parameters:
++to_native = $(foreach a,$(1),$(subst $(abs_srcdir),$(abs_srcdir_native),$(a)))
++write_entries_to_file_native = $(call write_entries_to_file, $(call to_native, $(1)), $(2))
+ # --------
+ # UNSORTED
+ # --------
+@@ -3784,7 +3792,7 @@
+ 
+ gtyp-input.list: s-gtyp-input ; @true
+ s-gtyp-input: Makefile
+-	@: $(call write_entries_to_file,$(GTFILES),tmp-gi.list)
++	@: $(call write_entries_to_file_native,$(GTFILES),tmp-gi.list)
+ 	$(SHELL) $(srcdir)/../move-if-change tmp-gi.list gtyp-input.list
+ 	$(STAMP) s-gtyp-input
+ 
-- 
1.8.4.3

