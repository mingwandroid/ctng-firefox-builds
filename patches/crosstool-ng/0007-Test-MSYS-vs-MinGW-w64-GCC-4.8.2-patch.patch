From ae4639afca269edc7f38ccf98d4c3e5dc8899099 Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Sun, 1 Dec 2013 16:57:31 +0000
Subject: [PATCH 7/7] Test MSYS vs MinGW-w64 GCC 4.8.2 patch

---
 .../gcc/4.8.2/100-msys-native-paths-gengtype.patch | 87 ++++++++++++++++++++++
 1 file changed, 87 insertions(+)
 create mode 100644 patches/gcc/4.8.2/100-msys-native-paths-gengtype.patch

diff --git a/patches/gcc/4.8.2/100-msys-native-paths-gengtype.patch b/patches/gcc/4.8.2/100-msys-native-paths-gengtype.patch
new file mode 100644
index 0000000..75c0212
--- /dev/null
+++ b/patches/gcc/4.8.2/100-msys-native-paths-gengtype.patch
@@ -0,0 +1,87 @@
+diff -urN gcc-4.8.2/gcc/Makefile.in gcc-4.8.2.new/gcc/Makefile.in
+--- gcc-4.8.2/gcc/Makefile.in	2013-07-08 10:14:34.000000000 +0100
++++ gcc-4.8.2.new/gcc/Makefile.in	2013-12-01 16:41:11.000000000 +0000
+@@ -72,6 +72,9 @@
+ 
+ # Directory where sources are, absolute.
+ abs_srcdir = @abs_srcdir@
++# Directory where soruces are, absolute, natively (for MSYS/Cygwin)
++abs_srcdir_native = @abs_srcdir_native@
++
+ abs_docdir = @abs_srcdir@/doc
+ 
+ # Top build directory for this package, relative to here.
+@@ -297,6 +300,11 @@
+ 			  $(shell expr $(range) + $(write_entries_to_file_split) - 1), $(1))" \
+ 	     | tr ' ' '\012' >> $(2)))
+ 
++# write_entries_to_file_native - as above, but replaces each entry with it's native
++# version first.
++# Parameters:
++to_native = $(foreach a,$(1),$(subst $(abs_srcdir),$(abs_srcdir_native),$(a)))
++write_entries_to_file_native = $(call write_entries_to_file, $(call to_native, $(1)), $(2))
+ # --------
+ # UNSORTED
+ # --------
+@@ -3784,7 +3792,7 @@
+ 
+ gtyp-input.list: s-gtyp-input ; @true
+ s-gtyp-input: Makefile
+-	@: $(call write_entries_to_file,$(GTFILES),tmp-gi.list)
++	@: $(call write_entries_to_file_native,$(GTFILES),tmp-gi.list)
+ 	$(SHELL) $(srcdir)/../move-if-change tmp-gi.list gtyp-input.list
+ 	$(STAMP) s-gtyp-input
+ 
+diff -urN gcc-4.8.2/gcc/configure gcc-4.8.2.new/gcc/configure
+--- gcc-4.8.2/gcc/configure	2013-06-19 02:18:38.000000000 +0100
++++ gcc-4.8.2.new/gcc/configure	2013-12-01 16:53:10.699231129 +0000
+@@ -934,6 +934,7 @@
+ CCC
+ CPP
+ CXXCPP
++abs_srcdir_native
+ GMPLIBS
+ GMPINC
+ ISLLIBS
+@@ -28600,6 +28601,15 @@
+ esac
+ ac_abs_srcdir=$ac_abs_top_srcdir$ac_dir_suffix
+ 
++# Hack for MSYS2 gengtypes filename emission when build
++# is 
++if test "$build_os" != "mingw32" ; then
++    abs_srcdir_native=$ac_abs_srcdir
++else
++    abs_srcdir_native=$(cd $ac_abs_srcdir; pwd -W)
++fi
++
++
+ 
+   case $ac_mode in
+   :F)
+@@ -28655,6 +28665,7 @@
+ s&@top_build_prefix@&$ac_top_build_prefix&;t t
+ s&@srcdir@&$ac_srcdir&;t t
+ s&@abs_srcdir@&$ac_abs_srcdir&;t t
++s&@abs_srcdir_native@&$abs_srcdir_native&;t t
+ s&@top_srcdir@&$ac_top_srcdir&;t t
+ s&@abs_top_srcdir@&$ac_abs_top_srcdir&;t t
+ s&@builddir@&$ac_builddir&;t t
+diff -urN gcc-4.8.2/gcc/configure.ac gcc-4.8.2.new/gcc/configure.ac
+--- gcc-4.8.2/gcc/configure.ac	2013-06-19 02:18:38.000000000 +0100
++++ gcc-4.8.2.new/gcc/configure.ac	2013-12-01 16:54:00.629228441 +0000
+@@ -5305,6 +5305,14 @@
+ 
+ # Create the Makefile
+ # and configure language subdirectories
++
++if test "$build_os" != "mingw32" ; then
++    abs_srcdir_native=$ac_abs_srcdir
++else
++    abs_srcdir_native=$(cd $ac_abs_srcdir; pwd -W)
++fi
++AC_SUBST(abs_srcdir_native)
++
+ AC_CONFIG_FILES($all_outputs)
+ 
+ AC_CONFIG_COMMANDS([default],
-- 
1.8.4.2

